---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: alloy
data:
  config.alloy: |
    // Discover Kubernetes pods
    discovery.kubernetes "pods" {
      role = "pod"
    }

    // Filter pods by namespace/labels and add useful labels
    discovery.relabel "logs" {
      targets = discovery.kubernetes.pods.targets

      // Keep all pods (filter out kube-system if desired)
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        action = "keep"
        regex = ".+"
      }

      // Add namespace label
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label = "namespace"
      }

      // Add pod label
      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label = "pod"
      }

      // Add container label
      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label = "container"
      }

      // Add node label
      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label = "node"
      }
    }

    // Collect pod logs
    loki.source.kubernetes "pods" {
      targets    = discovery.relabel.logs.output
      forward_to = [loki.write.endpoint.receiver]
    }

    // Forward to Loki
    loki.write "endpoint" {
      endpoint {
        url = "http://loki-gateway.loki:80/loki/api/v1/push"
      }
    }
